<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Visualising Temporal Trends • dubicube</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/PT_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Visualising Temporal Trends">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dubicube</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.10.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Tutorials</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../CONTRIBUTING.html">Contributing</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://b-cubed.eu/" aria-label="B-Cubed website"><span class="fa fa-cube"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/b-cubed-eu/dubicube/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Visualising Temporal Trends</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/b-cubed-eu/dubicube/blob/main/vignettes/articles/visualising-temporal-trends.Rmd" class="external-link"><code>vignettes/articles/visualising-temporal-trends.Rmd</code></a></small>
      <div class="d-none name"><code>visualising-temporal-trends.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial provides good practices regarding visualisation and
interpretation of trends of indicators over time. The methods discussed
here are more broadly applicable, be for this tutorial we focus on
occurrence cubes from which biodiversity indicators are derived. For
visualisation and interpretation, we strongly rely on the functionality
and concepts of the <a href="https://inbo.github.io/effectclass/articles/visualisation.html" class="external-link"><strong>effectclass</strong></a>
package.</p>
</div>
<div class="section level2">
<h2 id="calculating-confidence-intervals-with-dubicube">Calculating confidence intervals with dubicube<a class="anchor" aria-label="anchor" href="#calculating-confidence-intervals-with-dubicube"></a>
</h2>
<p>We reuse the example introduced in <a href="https://b-cubed-eu.github.io/dubicube/articles/bootstrap-method-cubes.html">bootstrap
confidence interval calculation tutorial</a> where we calculate
confidence limits for the mean number of observations per grid cell per
year for birds in Belgium between 2011 en 2020 using the MGRS grid at 10
km scale.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>      <span class="co"># Data visualisation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>        <span class="co"># Data wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>        <span class="co"># Data wrangling</span></span>
<span></span>
<span><span class="co"># Data loading and processing</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/frictionlessdata/frictionless-r" class="external-link">frictionless</a></span><span class="op">)</span> <span class="co"># Load example datasets</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/b-cubed-eu/b3gbi" class="external-link">b3gbi</a></span><span class="op">)</span>        <span class="co"># Process occurrence cubes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/b-cubed-eu/dubicube" class="external-link">dubicube</a></span><span class="op">)</span>     <span class="co"># Analysis of data quality &amp; indicator uncertainty</span></span></code></pre></div>
<div class="section level3">
<h3 id="loading-and-processing-the-data">Loading and processing the data<a class="anchor" aria-label="anchor" href="#loading-and-processing-the-data"></a>
</h3>
<p>We load the bird cube data from the <strong>b3data</strong> data
package using <strong>frictionless</strong> (see also <a href="https://github.com/b-cubed-eu/b3data-scripts" class="external-link">here</a>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read data package</span></span>
<span><span class="va">b3data_package</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_package.html" class="external-link">read_package</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://zenodo.org/records/15211029/files/datapackage.json"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load bird cube data</span></span>
<span><span class="va">bird_cube_belgium</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_resource.html" class="external-link">read_resource</a></span><span class="op">(</span><span class="va">b3data_package</span>, <span class="st">"bird_cube_belgium_mgrs10"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bird_cube_belgium</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;    year mgrscode specieskey species          family     n mincoordinateuncerta…¹</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">473</span>958 Perdix perdix    Phasi…     1                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">474</span>156 Coturnix coturn… Phasi…     1                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">474</span>377 Fulica atra      Ralli…     5                   <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">475</span>443 Merops apiaster  Merop…     6                   <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">480</span>242 Vanellus vanell… Chara…     1                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">2</span>000 31UDS65     2<span style="text-decoration: underline;">480</span>637 Accipiter nisus  Accip…     1                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​mincoordinateuncertaintyinmeters</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: familycount &lt;dbl&gt;</span></span></span></code></pre></div>
<p>We process the cube with <strong>b3gbi</strong>. First, we select
2000 random rows to make the dataset smaller. This is to reduce the
computation time for this tutorial. We select the data from 2011 -
2020.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make dataset smaller</span></span>
<span><span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bird_cube_belgium</span><span class="op">)</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">bird_cube_belgium</span> <span class="op">&lt;-</span> <span class="va">bird_cube_belgium</span><span class="op">[</span><span class="va">rows</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Process cube</span></span>
<span><span class="va">processed_cube</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://b-cubed-eu.github.io/b3gbi/reference/process_cube.html" class="external-link">process_cube</a></span><span class="op">(</span></span>
<span>  <span class="va">bird_cube_belgium</span>,</span>
<span>  first_year <span class="op">=</span> <span class="fl">2011</span>,</span>
<span>  last_year <span class="op">=</span> <span class="fl">2020</span>,</span>
<span>  cols_occurrences <span class="op">=</span> <span class="st">"n"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">processed_cube</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Processed data cube for calculating biodiversity indicators</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Date Range: 2011 - 2020 </span></span>
<span><span class="co">#&gt; Single-resolution cube with cell size 10km ^2 </span></span>
<span><span class="co">#&gt; Number of cells: 242 </span></span>
<span><span class="co">#&gt; Grid reference system: mgrs </span></span>
<span><span class="co">#&gt; Coordinate range:</span></span>
<span><span class="co">#&gt;    xmin    xmax    ymin    ymax </span></span>
<span><span class="co">#&gt;  280000  710000 5490000 5700000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total number of observations: 45143 </span></span>
<span><span class="co">#&gt; Number of species represented: 253 </span></span>
<span><span class="co">#&gt; Number of families represented: 57 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Kingdoms represented: Data not present </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; First 10 rows of data (use n = to show more):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 957 × 13</span></span></span>
<span><span class="co">#&gt;     year cellCode taxonKey scientificName    family   obs minCoordinateUncerta…¹</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">2</span>011 31UFS56   5<span style="text-decoration: underline;">231</span>918 Cuculus canorus   Cucul…    11                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">2</span>011 31UES28   5<span style="text-decoration: underline;">739</span>317 Phoenicurus phoe… Musci…     6                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">2</span>011 31UFS64   6<span style="text-decoration: underline;">065</span>824 Chroicocephalus … Larid…   143                   <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">2</span>011 31UFS96   2<span style="text-decoration: underline;">492</span>576 Muscicapa striata Musci…     3                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>011 31UES04   5<span style="text-decoration: underline;">231</span>198 Passer montanus   Passe…     1                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>011 31UES85   5<span style="text-decoration: underline;">229</span>493 Garrulus glandar… Corvi…    23                    707</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>011 31UES88  10<span style="text-decoration: underline;">124</span>612 Anser anser x Br… Anati…     1                    100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>011 31UES22   2<span style="text-decoration: underline;">481</span>172 Larus marinus     Larid…     8                   <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>011 31UFS43   2<span style="text-decoration: underline;">481</span>139 Larus argentatus  Larid…    10                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>011 31UFT00   9<span style="text-decoration: underline;">274</span>012 Spatula querqued… Anati…     8                   <span style="text-decoration: underline;">3</span>536</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 947 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​minCoordinateUncertaintyInMeters</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: familyCount &lt;dbl&gt;, xcoord &lt;dbl&gt;, ycoord &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   utmzone &lt;int&gt;, hemisphere &lt;chr&gt;, resolution &lt;chr&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="analysis-of-the-data">Analysis of the data<a class="anchor" aria-label="anchor" href="#analysis-of-the-data"></a>
</h3>
<p>Let’s say we are interested in the mean number of observations per
grid cell per year. We create a function to calculate this.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate statistic of interest</span></span>
<span><span class="co"># Mean observations per grid cell per year</span></span>
<span><span class="va">mean_obs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, .by <span class="op">=</span> <span class="st">"cellCode"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>diversity_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, .by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We get the following results:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mean_obs</span><span class="op">(</span><span class="va">processed_cube</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;    year diversity_val</span></span>
<span><span class="co">#&gt; 1  2011      34.17777</span></span>
<span><span class="co">#&gt; 2  2012      35.27201</span></span>
<span><span class="co">#&gt; 3  2013      33.25581</span></span>
<span><span class="co">#&gt; 4  2014      55.44160</span></span>
<span><span class="co">#&gt; 5  2015      49.24754</span></span>
<span><span class="co">#&gt; 6  2016      48.34063</span></span>
<span><span class="co">#&gt; 7  2017      70.42202</span></span>
<span><span class="co">#&gt; 8  2018      48.83850</span></span>
<span><span class="co">#&gt; 9  2019      47.46795</span></span>
<span><span class="co">#&gt; 10 2020      43.00411</span></span></code></pre></div>
<p>On their own, these values don’t reveal how much uncertainty
surrounds them. To better understand their variability, we use
bootstrapping to estimate the distribution of the yearly means. From
this, we can calculate bootstrap confidence intervals.</p>
</div>
<div class="section level3">
<h3 id="bootstrapping">Bootstrapping<a class="anchor" aria-label="anchor" href="#bootstrapping"></a>
</h3>
<p>We use the <code><a href="../reference/bootstrap_cube.html">bootstrap_cube()</a></code> function to perform
bootstrapping (see also the <a href="https://b-cubed-eu.github.io/dubicube/articles/bootstrap-method-cubes.html">bootstrap
tutorial</a>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootstrap_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootstrap_cube.html">bootstrap_cube</a></span><span class="op">(</span></span>
<span>  data_cube <span class="op">=</span> <span class="va">processed_cube</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">mean_obs</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Performing whole-cube bootstrap with `boot::boot()`."</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interval-calculation">Interval calculation<a class="anchor" aria-label="anchor" href="#interval-calculation"></a>
</h3>
<p>Now we can use the <code><a href="../reference/calculate_bootstrap_ci.html">calculate_bootstrap_ci()</a></code> function to
calculate confidence limits (see also the <a href="https://b-cubed-eu.github.io/dubicube/articles/bootstrap-method-cubes.html">bootstrap
confidence interval calculation tutorial</a>). We get a warning message
for BCa calculation because we are using a relatively small dataset.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ci_mean_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_bootstrap_ci.html">calculate_bootstrap_ci</a></span><span class="op">(</span></span>
<span>  bootstrap_samples_df <span class="op">=</span> <span class="va">bootstrap_results</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"perc"</span>, <span class="st">"bca"</span>, <span class="st">"norm"</span>, <span class="st">"basic"</span><span class="op">)</span>,</span>
<span>  conf <span class="op">=</span> <span class="fl">0.95</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in norm.inter(t, adj.alpha): extreme order statistics used as endpoints</span></span>
<span></span>
<span><span class="co"># Make interval type factor</span></span>
<span><span class="va">ci_mean_obs</span> <span class="op">&lt;-</span> <span class="va">ci_mean_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>    int_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="va">int_type</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"perc"</span>, <span class="st">"bca"</span>, <span class="st">"norm"</span>, <span class="st">"basic"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ci_mean_obs</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year est_original int_type       ll       ul conf</span></span>
<span><span class="co">#&gt; 1 2011     34.17777     norm 26.20924 43.08325 0.95</span></span>
<span><span class="co">#&gt; 2 2011     34.17777    basic 24.99408 42.17612 0.95</span></span>
<span><span class="co">#&gt; 3 2011     34.17777     perc 26.17942 43.36146 0.95</span></span>
<span><span class="co">#&gt; 4 2011     34.17777      bca 27.43845 45.60900 0.95</span></span>
<span><span class="co">#&gt; 5 2012     35.27201     norm 28.62332 43.67756 0.95</span></span>
<span><span class="co">#&gt; 6 2012     35.27201    basic 28.26708 43.07078 0.95</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="visualising-uncertainty-in-temporal-trends">Visualising uncertainty in temporal trends<a class="anchor" aria-label="anchor" href="#visualising-uncertainty-in-temporal-trends"></a>
</h2>
<div class="section level3">
<h3 id="error-bars">Error bars<a class="anchor" aria-label="anchor" href="#error-bars"></a>
</h3>
<p>The use of error bars is an easy and straightforward way to visualise
uncertainty around indicator estimates.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ci_mean_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">est_original</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span><span class="op">)</span>,</span>
<span>                position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Estimates</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"firebrick"</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">int_type</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" alt="Confidence intervals for mean number of occurrences over time." width="700"></p>
<p>However, the question remains which interval types should be
calculated and/or reported. A good idea is to compare different interval
types next to each other together with the bootstrap distribution and
the bootstrap bias (the difference between the estimate and the
bootstrap estimate).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert bootstrap replicates to dataframe</span></span>
<span><span class="va">bootstrap_results_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_list_to_dataframe.html">boot_list_to_dataframe</a></span><span class="op">(</span></span>
<span>  boot_list <span class="op">=</span> <span class="va">bootstrap_results</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get bias vales</span></span>
<span><span class="va">bias_mean_obs</span> <span class="op">&lt;-</span> <span class="va">bootstrap_results_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">year</span>, estimate <span class="op">=</span> <span class="va">est_original</span>, `bootstrap estimate` <span class="op">=</span> <span class="va">est_boot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get estimate values</span></span>
<span><span class="va">estimate_mean_obs</span> <span class="op">&lt;-</span> <span class="va">bias_mean_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"bootstrap estimate"</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"Legend"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Legend</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"bootstrap estimate"</span><span class="op">)</span>,</span>
<span>                         ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Visualise</span></span>
<span><span class="va">bootstrap_results_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Distribution</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">rep_boot</span>, group <span class="op">=</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Estimates and bias</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_mean_obs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span>, shape <span class="op">=</span> <span class="va">Legend</span><span class="op">)</span>,</span>
<span>             colour <span class="op">=</span> <span class="st">"firebrick"</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ci_mean_obs</span>,</span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span>, colour <span class="op">=</span> <span class="va">int_type</span><span class="op">)</span>,</span>
<span>                position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">""</span>, shape <span class="op">=</span> <span class="st">"Legend:"</span>, colour <span class="op">=</span> <span class="st">"Interval type:"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results_df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using shapes for an ordinal variable is not advised</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" alt="Confidence intervals with bootstrap distribution for mean number of occurrences over time." width="700"></p>
<p>This informs us about the shape of the bootstrap distribution and the
amount of bootstrap bias. In combination with bootstrap interval theory,
it can be decided which interval type(s) should be reported. In general,
because of the wide range of biodiversity indicator types, we recommend
the use of percentile or BCa intervals, because they have no strong
assumptions regarding the bootstrap distribution. The BCa interval is
recommended as it accounts for bias and skewness. However, due to the
jackknife estimation of the acceleration parameter, the calculation time
is significantly longer. The use of the normal and basic confidence
intervals is not recommended, but could be used in combination with
truncations or transformations. The assumption of normality can be
checked by making a Q-Q plot of the bootstrap replications (see further)
(Davison &amp; Hinkley, <a href="https://doi.org/10.1017/CBO9780511802843" class="external-link">1997</a>). An overview
of the recommendations is provided in the table below. This is not an
exhaustive review of the topic, but based on existing literature and our
preliminary results, these recommendations provide a useful starting
point for selecting appropriate interval types.</p>
<!-- spell-check: ignore:start -->
<table style="table-layout: auto; width: 100%;" class="table">
<thead><tr>
<th style="white-space: nowrap;">
Interval type
</th>
<th>
Advantages
</th>
<th>
Disadvantages
</th>
<th>
References
</th>
</tr></thead>
<tbody>
<tr>
<td>
<strong>Normal</strong>
</td>
<td>
<ul>
<li>
Simplicity
</li>
<li>
Understanding of bootstrap and CI theory
</li>
</ul>
</td>
<td>
<ul>
<li>
Assumes bootstrap distribution is normal
</li>
<li>
Often, transformation needed for more accurate results
</li>
<li>
Erratic coverage error in practice
</li>
</ul>
</td>
<td>
Davison &amp; Hinkley
(<a href="https://doi.org/10.1017/CBO9780511802843" class="external-link">1997, Ch.
5</a>);<br> Efron &amp; Tibshirani
(<a href="https://doi.org/10.1201/9780429246593" class="external-link">1994, Ch. 13</a>);<br>
Hesterberg
(<a href="https://doi.org/10.1080/00031305.2015.1089789" class="external-link">2015</a>)
</td>
</tr>
<tr>
<td>
<strong>Basic</strong>
</td>
<td>
<ul>
<li>
Simplicity
</li>
<li>
Understanding of bootstrap and CI theory
</li>
</ul>
</td>
<td>
<ul>
<li>
Assumes symmetric bootstrap distribution
</li>
<li>
Typically substantial coverage error
</li>
</ul>
</td>
<td>
Carpenter &amp; Bithell
(<a href="https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9%3C1141::AID-SIM479%3E3.0.CO;2-F" class="external-link">2000</a>);<br>
Davison &amp; Hinkley
(<a href="https://doi.org/10.1017/CBO9780511802843" class="external-link">1997, Ch.
5</a>);<br> Hesterberg
(<a href="https://doi.org/10.1080/00031305.2015.1089789" class="external-link">2015</a>)
</td>
</tr>
<tr>
<td>
<strong>Percentile</strong>
</td>
<td>
<ul>
<li>
Simplicity
</li>
<li>
No assumptions about bootstrap distribution
</li>
<li>
Implicitly uses the existence of a good transformation
</li>
</ul>
</td>
<td>
<ul>
<li>
Does not take bias into account
</li>
<li>
Substantial coverage error if the distribution is not nearly symmetric
</li>
</ul>
</td>
<td>
Carpenter &amp; Bithell
(<a href="https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9%3C1141::AID-SIM479%3E3.0.CO;2-F" class="external-link">2000</a>);<br>
Davison &amp; Hinkley
(<a href="https://doi.org/10.1017/CBO9780511802843" class="external-link">1997, Ch.
5</a>);<br> Efron &amp; Tibshirani
(<a href="https://doi.org/10.1201/9780429246593" class="external-link">1994, Ch. 13</a>)
</td>
</tr>
<tr>
<td>
<strong>BCa</strong>
</td>
<td>
<ul>
<li>
No assumptions about bootstrap distribution
</li>
<li>
Implicitly uses the existence of a good transformation
</li>
<li>
Adjusts for bias
</li>
<li>
Adjusts for skewness
</li>
<li>
Smaller coverage error than the other methods
</li>
</ul>
</td>
<td>
<ul>
<li>
Involved calculation of acceleration parameter <code>a</code>
</li>
<li>
Unstable coverage when sample size is small or <code>a</code> is small
</li>
</ul>
</td>
<td>
Carpenter &amp; Bithell
(<a href="https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9%3C1141::AID-SIM479%3E3.0.CO;2-F" class="external-link">2000</a>);<br>
Davison &amp; Hinkley
(<a href="https://doi.org/10.1017/CBO9780511802843" class="external-link">1997, Ch.
5</a>);<br> Dixon
(<a href="https://doi.org/10.1093/oso/9780195131871.003.0014" class="external-link">2000</a>);<br>
Efron &amp; Tibshirani
(<a href="https://doi.org/10.1201/9780429246593" class="external-link">1994, Ch. 14</a>)
</td>
</tr>
</tbody>
</table>
<!-- spell-check: ignore:end -->
</div>
<div class="section level3">
<h3 id="smooth-trends">Smooth trends<a class="anchor" aria-label="anchor" href="#smooth-trends"></a>
</h3>
<p>To create a more continuous representation of change over time, we
can apply LOESS (Locally Estimated Scatterplot Smoothing) to the
estimates and confidence limits. This smoothing technique fits local
regressions across subsets of the data, producing a flexible trend line
that helps visualize broader patterns while retaining important
details.</p>
<p>It should be noted that this may complicate interpretation of the
results. Occurrence cubes are by definition categorical over time (in
this case by year), so smoothing things out over time while the data
have been aggregated might lead to different results compared to a
similar analysis on the original data (before the cube was made and
aggregation occurred). Therefore, we recommend this visualisation for
long time series to make general interpretations of the trend over time.
In our example, we actually have a small time frame so we only show this
for the sake of the tutorial.</p>
<p>Based on the discussion above, we select the BCa interval as we see
some asymmetry and bias in the bootstrap distribution of later years.
Note that this is probably due to the selection 2000 random rows from
the original dataset to reduce the computation time for this tutorial.
Otherwise we would expect a more symmetrical distribution for this
indicator.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ci_mean_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_type</span> <span class="op">==</span> <span class="st">"bca"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">est_original</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"solid"</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">"y ~ x"</span>,</span>
<span>    se <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ul</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="st">"lightsteelblue1"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">"y ~ x"</span>,</span>
<span>    se <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ll</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="st">"lightsteelblue1"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">"y ~ x"</span>,</span>
<span>    se <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">ll</span> <span class="op">~</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span>, ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">ul</span> <span class="op">~</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span>, fill <span class="op">=</span> <span class="st">"lightsteelblue1"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span><span class="op">)</span>,</span>
<span>                position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Estimates</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"firebrick"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" alt="Confidence intervals with loess smoother." width="700"></p>
</div>
<div class="section level3">
<h3 id="fan-plots">Fan plots<a class="anchor" aria-label="anchor" href="#fan-plots"></a>
</h3>
<p>The <strong>effectclass</strong> package provides the
<code><a href="https://inbo.github.io/effectclass/reference/stat_fan.html" class="external-link">stat_fan()</a></code> function to create fan plot intervals (see also
this <a href="https://inbo.github.io/effectclass/articles/visualisation.html#stat_fan" class="external-link"><strong>effectclass</strong>
tutorial</a>).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inbo.github.io/effectclass/" class="external-link">effectclass</a></span><span class="op">)</span></span></code></pre></div>
<p>These intervals are based on a normal distribution or a
transformation via the <code>link</code> argument. Therefore, we check
the assumption of normality by making a Q-Q plot of the bootstrap
replications.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bootstrap_results_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">rep_boot</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Q-Q plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html" class="external-link">stat_qq</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html" class="external-link">stat_qq_line</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantiles (Standard Normal)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Sample Quantiles (Bootstrap Replicates)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" alt="Q-Q plot of bootstrap replications." width="700"></p>
<p>As expected, it looks like the bootstrap distributions are not
normally distributed in most years. If we log-transform the bootstrap
replications, the Q-Q plots look better.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bootstrap_results_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rep_boot</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Q-Q plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html" class="external-link">stat_qq</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html" class="external-link">stat_qq_line</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantiles (Standard Normal)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Sample Quantiles (Bootstrap Replicates)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" alt="Q-Q plot of log-transformed bootstrap replications." width="700"></p>
<p>We therefore calculate the log-transformed normal intervals and
compare them with the BCa and normal intervals.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ci_mean_obs_lognorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_bootstrap_ci.html">calculate_bootstrap_ci</a></span><span class="op">(</span></span>
<span>  bootstrap_samples_df <span class="op">=</span> <span class="va">bootstrap_results</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"norm"</span><span class="op">)</span>,</span>
<span>  conf <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  h <span class="op">=</span> <span class="va">log</span>,</span>
<span>  hinv <span class="op">=</span> <span class="va">exp</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The log-normal intervals look indeed more correct then the normal
intervals, although they still differ from the BCa intervals.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine interval data</span></span>
<span><span class="va">ci_mean_obs_new</span> <span class="op">&lt;-</span> <span class="va">ci_mean_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bca"</span>, <span class="st">"norm"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">ci_mean_obs_lognorm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>             int_type <span class="op">=</span> <span class="st">"log_norm"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualise</span></span>
<span><span class="va">bootstrap_results_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Distribution</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">rep_boot</span>, group <span class="op">=</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Estimates and bias</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_mean_obs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span>, shape <span class="op">=</span> <span class="va">Legend</span><span class="op">)</span>,</span>
<span>             colour <span class="op">=</span> <span class="st">"firebrick"</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ci_mean_obs_new</span>,</span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span>, colour <span class="op">=</span> <span class="va">int_type</span><span class="op">)</span>,</span>
<span>                position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">""</span>, shape <span class="op">=</span> <span class="st">"Legend:"</span>, colour <span class="op">=</span> <span class="st">"Interval type:"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" alt="Compare log-normal intervals." width="700"></p>
<p>Finally, we can create a fan plot assuming the log-normal
distribution. Note that for <code><a href="https://inbo.github.io/effectclass/reference/stat_fan.html" class="external-link">stat_fan()</a></code>, the
<code>link_sd</code> is the standard error on the link scale, while
<code>y</code> is on the natural scale. So we have to recalculate the
standard error on the log-transformed bootstrap replicates. We also need
to account for bias. As noted in the previous section, year is a
discrete variable in our data cube. We therefore use the
<code>geom = "rect"</code> option.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootstrap_results_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate standard error on link scale</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rep_boot_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rep_boot</span><span class="op">)</span>,</span>
<span>         est_boot_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rep_boot_log</span><span class="op">)</span>, <span class="co"># Needed for bias calculation</span></span>
<span>         se_boot_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">rep_boot_log</span><span class="op">)</span>,</span>
<span>         .by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Get unique estimates per year</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">est_original</span>, <span class="va">est_boot_log</span>, <span class="va">se_boot_log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate bias factor</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>bias_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est_boot_log</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">est_original</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Visualise</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">effectclass</span><span class="fu">::</span><span class="fu"><a href="https://inbo.github.io/effectclass/reference/stat_fan.html" class="external-link">stat_fan</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">est_original</span> <span class="op">/</span> <span class="va">bias_log</span>, link_sd <span class="op">=</span> <span class="va">se_boot_log</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="st">"log"</span>, fill <span class="op">=</span> <span class="st">"cornflowerblue"</span>, max_prob <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>    geom <span class="op">=</span> <span class="st">"rect"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-20-1.png" class="r-plt" alt="Categorical fan plot of log-normal interval with effectclass." width="700"></p>
<p>We can make use of this concept to make fan plots for other interval
types ourselves. We calculate BCA and log-normal intervals for five
coverages using a for loop.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up coverage levels</span></span>
<span><span class="va">max_prob</span> <span class="op">&lt;-</span> <span class="fl">0.95</span></span>
<span><span class="va">step</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">coverages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">max_prob</span>, <span class="fl">1e-3</span>, by <span class="op">=</span> <span class="op">-</span><span class="va">step</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop over coverages</span></span>
<span><span class="va">out_ci_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coverages</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">coverages</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cov</span> <span class="op">&lt;-</span> <span class="va">coverages</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Calculate confidence limits for confidence level</span></span>
<span>  <span class="va">ci_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_bootstrap_ci.html">calculate_bootstrap_ci</a></span><span class="op">(</span></span>
<span>    bootstrap_samples_df <span class="op">=</span> <span class="va">bootstrap_results</span>,</span>
<span>    grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bca"</span>, <span class="st">"norm"</span><span class="op">)</span>,</span>
<span>    conf <span class="op">=</span> <span class="va">cov</span>,</span>
<span>    h <span class="op">=</span> <span class="va">log</span>,</span>
<span>    hinv <span class="op">=</span> <span class="va">exp</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">out_ci_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ci_cov</span></span>
<span><span class="op">}</span></span>
<span><span class="va">out_ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">out_ci_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>    int_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">int_type</span> <span class="op">==</span> <span class="st">"norm"</span>, <span class="st">"log_norm"</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can visualise this in a categorical way with
<code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect()</a></code> from <strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For visualisation of envelopes</span></span>
<span><span class="va">alpha_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">coverages</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">i</span> <span class="op">/</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">step</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alpha_levels</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">coverages</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert conf to character so it can match alpha_levels</span></span>
<span><span class="va">out_ci</span> <span class="op">&lt;-</span> <span class="va">out_ci</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    conf_chr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">conf</span><span class="op">)</span>,</span>
<span>    year_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="co"># Numeric year for xmin/xmax</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualise</span></span>
<span><span class="va">bar_width</span> <span class="op">&lt;-</span> <span class="fl">0.9</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">out_ci</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      xmin <span class="op">=</span> <span class="va">year_num</span> <span class="op">-</span> <span class="va">bar_width</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>      xmax <span class="op">=</span> <span class="va">year_num</span> <span class="op">+</span> <span class="va">bar_width</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>      ymin <span class="op">=</span> <span class="va">ll</span>,</span>
<span>      ymax <span class="op">=</span> <span class="va">ul</span>,</span>
<span>      fill <span class="op">=</span> <span class="va">conf_chr</span>,</span>
<span>      alpha <span class="op">=</span> <span class="va">conf_chr</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Colour ribbons</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">alpha_levels</span>, name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha_levels</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">out_ci</span><span class="op">$</span><span class="va">year_num</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">out_ci</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">int_type</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-22-1.png" class="r-plt" alt="Categorical fan plot of BCa and log-normal intervals." width="700"></p>
<p>We can visualise this in a continuous way with
<code><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon()</a></code> from <strong>ggplot2</strong>. Linear (like
the default of <code><a href="https://inbo.github.io/effectclass/reference/stat_fan.html" class="external-link">stat_fan()</a></code>):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">out_ci</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span>, fill <span class="op">=</span> <span class="va">conf_chr</span>, alpha <span class="op">=</span> <span class="va">conf_chr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Colour ribbons</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">alpha_levels</span>, name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha_levels</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">int_type</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-23-1.png" class="r-plt" alt="Linear fan plot of BCa and log-normal intervals." width="700"></p>
<p>Smooth (like in the previous paragraph):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Predict smooth ymin/ymax</span></span>
<span><span class="va">out_ci</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">conf_chr</span>, <span class="va">int_type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">ll</span> <span class="op">~</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">ul</span> <span class="op">~</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Visualise</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ymin</span>, ymax <span class="op">=</span> <span class="va">ymax</span>, fill <span class="op">=</span> <span class="va">conf_chr</span>, alpha <span class="op">=</span> <span class="va">conf_chr</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Colour ribbons</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">alpha_levels</span>, name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">alpha_levels</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">"conf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell"</span>, x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bootstrap_results</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">int_type</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-24-1.png" class="r-plt" alt="Smooth fan plot of BCa and log-normal intervals." width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="visualising-temporal-effects">Visualising temporal effects<a class="anchor" aria-label="anchor" href="#visualising-temporal-effects"></a>
</h2>
<p>In <a href="https://b-cubed-eu.github.io/dubicube/articles/effect-classification.html">this
tutorial</a>, we demonstrated how to classify effect sizes based on
confidence intervals. Here we give some visualisation options based on
the <strong>effectclass</strong> package (see also this <a href="https://inbo.github.io/effectclass/articles/visualisation.html#stat_effect-and-scale_effect" class="external-link"><strong>effectclass</strong>
tutorial</a>).</p>
<p>Let’s calculate the BCa interval for the mean number of observations
per grid cell compared to 2011 and perform effect classification with
threshold 5.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bootstrapping</span></span>
<span><span class="va">bootstrap_results_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootstrap_cube.html">bootstrap_cube</a></span><span class="op">(</span></span>
<span>  data_cube <span class="op">=</span> <span class="va">processed_cube</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">mean_obs</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  ref_group <span class="op">=</span> <span class="fl">2011</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Performing whole-cube bootstrap."</span></span>
<span></span>
<span><span class="co"># Calculate confidence intervals</span></span>
<span><span class="va">ci_mean_obs_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_bootstrap_ci.html">calculate_bootstrap_ci</a></span><span class="op">(</span></span>
<span>  bootstrap_samples_df <span class="op">=</span> <span class="va">bootstrap_results_ref</span>,</span>
<span>  grouping_var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"bca"</span>,</span>
<span>  data_cube <span class="op">=</span> <span class="va">processed_cube</span>,   <span class="co"># Required for BCa</span></span>
<span>  fun <span class="op">=</span> <span class="va">mean_obs</span>,               <span class="co"># Required for BCa</span></span>
<span>  ref_group <span class="op">=</span> <span class="fl">2011</span>              <span class="co"># Required for BCa</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in norm_inter(h(t), adj_alpha): Extreme order statistics used as</span></span>
<span><span class="co">#&gt; endpoints.</span></span>
<span><span class="co">#&gt; Warning in norm_inter(h(t), adj_alpha): Extreme order statistics used as</span></span>
<span><span class="co">#&gt; endpoints.</span></span>
<span></span>
<span><span class="co"># Perform effect classification</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_effect_classification.html">add_effect_classification</a></span><span class="op">(</span></span>
<span>  df <span class="op">=</span> <span class="va">ci_mean_obs_ref</span>,</span>
<span>  cl_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ll"</span>, <span class="st">"ul"</span><span class="op">)</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  reference <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the result</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt;   year est_original    est_boot   se_boot  bias_boot int_type conf          ll</span></span>
<span><span class="co">#&gt; 1 2012    1.0942452  0.65831911  5.475053 -0.4359261      bca 0.95 -10.7621638</span></span>
<span><span class="co">#&gt; 2 2013   -0.9219589 -0.07108256  6.690590  0.8508764      bca 0.95 -12.8513851</span></span>
<span><span class="co">#&gt; 3 2014   21.2638321 19.32958556 10.982093 -1.9342466      bca 0.95   5.8187198</span></span>
<span><span class="co">#&gt; 4 2015   15.0697689 14.80578656 10.723767 -0.2639823      bca 0.95   2.5039329</span></span>
<span><span class="co">#&gt; 5 2016   14.1628569 13.30622198 12.131657 -0.8566350      bca 0.95  -1.7552656</span></span>
<span><span class="co">#&gt; 6 2017   36.2442462 43.13141123 23.943155  6.8871650      bca 0.95   7.1906529</span></span>
<span><span class="co">#&gt; 7 2018   14.6607335 14.98367972 10.715491  0.3229462      bca 0.95   0.3961534</span></span>
<span><span class="co">#&gt; 8 2019   13.2901788  8.46222485 13.048145 -4.8279539      bca 0.95  -0.5622564</span></span>
<span><span class="co">#&gt; 9 2020    8.8263369  5.37019562 13.084703 -3.4561413      bca 0.95  -5.3273172</span></span>
<span><span class="co">#&gt;         ul effect_code effect_code_coarse             effect effect_coarse</span></span>
<span><span class="co">#&gt; 1 11.04344           ?                  ?            unknown       unknown</span></span>
<span><span class="co">#&gt; 2 13.06589           ?                  ?            unknown       unknown</span></span>
<span><span class="co">#&gt; 3 57.17064          ++                  +    strong increase      increase</span></span>
<span><span class="co">#&gt; 4 58.08685           +                  +           increase      increase</span></span>
<span><span class="co">#&gt; 5 52.49345          ?+                  ? potential increase       unknown</span></span>
<span><span class="co">#&gt; 6 96.55713          ++                  +    strong increase      increase</span></span>
<span><span class="co">#&gt; 7 48.95507           +                  +           increase      increase</span></span>
<span><span class="co">#&gt; 8 69.67581          ?+                  ? potential increase       unknown</span></span>
<span><span class="co">#&gt; 9 65.47783           ?                  ?            unknown       unknown</span></span></code></pre></div>
<p>The <strong>effectclass</strong> package provides the
<code><a href="https://inbo.github.io/effectclass/reference/stat_effect.html" class="external-link">stat_effect()</a></code> function that visualises the effects with
colours and symbols.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">result</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">est_original</span>, ymin <span class="op">=</span> <span class="va">ll</span>, ymax <span class="op">=</span> <span class="va">ul</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">effectclass</span><span class="fu">::</span><span class="fu"><a href="https://inbo.github.io/effectclass/reference/stat_effect.html" class="external-link">stat_effect</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="fl">0</span>, threshold <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Settings</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean Number of Observations\nper Grid Cell Compared to 2011"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visualising-temporal-trends_files/figure-html/unnamed-chunk-26-1.png" class="r-plt" alt="Effect visualisation for mean number of occurrences over per year compared to 2011." width="700"></p>
<p>With this function, you can also add symbols to
<code><a href="https://inbo.github.io/effectclass/reference/stat_fan.html" class="external-link">stat_fan()</a></code>.</p>
<p>Note that the choice of the reference year should be well considered.
Keep in mind which comparisons should be made, and what the motivation
is behind the reference period. A high or low value in the reference
period relative to other periods, e.g. an exceptional bad or good year,
can affect the magnitude and direction of the calculated differences.
Whether this should be avoided or not, depends on the motivation behind
the choice and the research question. A reference period can be
determined by legislation, or by the start of a monitoring campaign. A
specific research question can determine the periods that need to be
compared. Furthermore, the variability of the estimate of reference
period affects the width of confidence intervals for the differences. A
more variable reference period will propagate greater uncertainty. In
the case of GBIF data, more data will be available in recent years than
in earlier years. If this is the case, it could make sense to select the
last period as a reference period. In a way, this also avoids the
arbitrariness of choice for the reference period. You compare previous
situations with the current situation (last year), where you could
repeat this comparison annually, for example. Finally, when comparing
multiple indicators, we recommend using a consistent reference period to
maintain comparability</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<!-- spell-check: ignore:start -->
<p>Carpenter, J., &amp; Bithell, J. (2000). Bootstrap confidence
intervals: When, which, what? A practical guide for medical
statisticians. <em>Statistics in Medicine, 19</em>(9), 1141–1164. <a href="https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9%3C1141::AID-SIM479%3E3.0.CO;2-F" class="external-link">https://doi.org/10.1002/(SICI)1097-0258(20000515)19:9&lt;1141::AID-SIM479&gt;3.0.CO;2-F</a></p>
<p>Davison, A. C., &amp; Hinkley, D. V. (1997). <em>Bootstrap Methods
and their Application</em> (1st ed.). Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511802843" class="external-link uri">https://doi.org/10.1017/CBO9780511802843</a></p>
<p>Dixon, P. M. (2001). The Bootstrap and the Jackknife: Describing the
Precision of Ecological Indices. In S. M. Scheiner &amp; J. Gurevitch
(Eds.), <em>Design and Analysis of Ecological Experiments</em> (Second
Edition, pp. 267–288). Oxford University PressNew York, NY. <a href="https://doi.org/10.1093/oso/9780195131871.003.0014" class="external-link uri">https://doi.org/10.1093/oso/9780195131871.003.0014</a></p>
<p>Efron, B., &amp; Tibshirani, R. J. (1994). <em>An Introduction to the
Bootstrap</em> (1st ed.). Chapman and Hall/CRC. <a href="https://doi.org/10.1201/9780429246593" class="external-link uri">https://doi.org/10.1201/9780429246593</a></p>
<p>Hesterberg, T. C. (2015). What Teachers Should Know About the
Bootstrap: Resampling in the Undergraduate Statistics Curriculum.
<em>The American Statistician, 69</em>(4), 371–386. <a href="https://doi.org/10.1080/00031305.2015.1089789" class="external-link uri">https://doi.org/10.1080/00031305.2015.1089789</a>
<!-- spell-check: ignore:end --></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ward Langeraert, Toon Van Daele, <a href="https://doi.org/10.3030/101059592" class="external-link"><img src="https://github.com/b-cubed-eu/dubicube/blob/main/man/figures/eu-funded-en.png?raw=true" height="35" alt="logo of the European Union"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
