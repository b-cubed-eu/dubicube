---
title: "Bootstrap Method for Data Cubes"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

When working with data cubes, it’s essential to understand the uncertainty surrounding derived statistics. This tutorial introduces the `bootstrap_cube()` function from **dubicube**,  which uses bootstrap resampling to estimate the variability, bias, and standard error of estimates.

## Bootstrapping for data cubes

Bootstrapping is a resampling method used to approximate the distribution of a statistic by repeatedly sampling from the data with replacement. In the context of biodiversity data cubes, `bootstrap_cube()` enables us to assess the variability of derived statistics, such as by computing confidence intervals.

### A data cube and a statistic

Consider a data cube $\mathbf{X}$ from which we want to calculate a statistic $\theta$.

- **Original Sample Data**: $\mathbf{X} = \{X_1, X_2, \ldots, X_n\}$  
   - The initial set of data points. Here, $n$ is the sample size.
   This corresponds to the number of cells in a data cube or the number of rows in tabular format.

- **Statistic of Interest**: $\theta$  
   - The parameter or statistic being estimated, such as the mean $\bar{X}$, variance $\sigma^2$, or a biodiversity indicator.
   Let $\hat{\theta}$ denote the estimated value of $\theta$ calculated from the complete dataset $\mathbf{X}$.

### Resampling and recalculating

From $\mathbf{X}$, multiple resampled datasets $\mathbf{X}^*$ are created by sampling rows (cells) with replacement until each new dataset is equally large as $\mathbf{X}$.
This process is repeated $B$ times, and each resample yields a new estimate $\hat{\theta}^*_b$ of the statistic.

- **Bootstrap Sample**: $\mathbf{X}^* = \{X_1^*, X_2^*, \ldots, X_n^*\}$
   - A sample of size $n$ drawn with replacement from the original sample
   $\mathbf{X}$. Each $X_i^*$ is drawn independently from
   $\mathbf{X}$.
   - A total of $B$ bootstrap samples are drawn from the original data.
   Common choices for $B$ are 1000 or 10,000 to ensure a good
   approximation of the distribution of the bootstrap replications (see
   further).

- **Bootstrap Replication**: $\hat{\theta}^*_b$
   - The value of the statistic of interest calculated from the $b$-th
   bootstrap sample $\mathbf{X}^*_b$. For example, if $\theta$ is
   the sample mean, $\hat{\theta}^*_b = \bar{X}^*_b$.

### Derivation of bootstrap statistics

The set of bootstrap replications forms the bootstrap distribution, which can be used to estimate bootstrap statistics and construct confidence intervals.

- **Bootstrap Estimate of the Statistic**: $\hat{\theta}_{\text{boot}}$
  - The average of the bootstrap replications:

$$
\hat{\theta}_{\text{boot}} = \frac{1}{B} \sum_{b=1}^B \hat{\theta}^*_b
$$

- **Bootstrap Bias**: $\text{Bias}_{\text{boot}}$
   - This bias indicates how much the bootstrap estimate deviates from the
   original sample estimate. It is calculated as the difference between the
   average bootstrap estimate and the original estimate:

$$
\text{Bias}_{\text{boot}} = \frac{1}{B} \sum_{b=1}^B (\hat{\theta}^*_b - \hat{\theta}) = \hat{\theta}_{\text{boot}} - \hat{\theta}
$$

- **Bootstrap Standard Error**: $\text{SE}_{\text{boot}}$
   - The standard deviation of the bootstrap replications, which estimates
   the variability of the statistic.
   
```{r}
#| fig.alt: >
#|   Bootstrap resampling a data cube.
knitr::include_graphics("../../man/figures/bootstrapping.png")
```

## Getting started with dubicube

Our method can be used on any dataframe from which a statistic is calculated and a grouping variable is present.
For this tutorial, we focus on occurrence cubes.
Therefore, we will use the **b3gbi** package for processing the raw data before we go over to bootstrapping.

```{r}
# Load packages
library(dubicube)

# Data loading and processing
library(frictionless) # Load example datasets
library(b3gbi)        # Process occurrence cubes

# General
library(ggplot2)      # Data visualisation
```

### Loading and processing the data

We load the bird cube data from the **b3data** data package using **frictionless** (see also [here](https://github.com/b-cubed-eu/b3data-scripts)).
It is an occurrence cube for birds in Belgium between 2000 en 2024 using the MGRS grid at 10 km scale.

```{r}
# Read data package
b3data_package <- read_package(
  "https://zenodo.org/records/15211029/files/datapackage.json"
)

# Load bird cube data
bird_cube_belgium <- read_resource(b3data_package, "bird_cube_belgium_mgrs10")
head(bird_cube_belgium)
```

We process the cube with **b3gbi**.
We select the data from 2011 - 2020.

```{r}
processed_cube <- process_cube(
  bird_cube_belgium,
  first_year = 2011,
  last_year = 2020,
  cols_occurrences = "n"
)
processed_cube
```

### Analysis of the data

Let's say we are interested in the mean number of observations per year.
We create a function to calculate this.

```{r}
# Function to calculate statistic of interest
# Mean observations per year
mean_obs <- function(data) {
  out_df <- aggregate(obs ~ year, data, mean) # Calculate mean obs per year
  names(out_df) <- c("year", "diversity_val") # Rename columns
  return(out_df)
}
```

We get the following results:

```{r}
mean_obs(processed_cube$data)
```

On their own, these values don’t reveal how much uncertainty surrounds them. To better understand their variability, we use bootstrapping to estimate the distribution of the yearly means.

### Bootstrapping

We use the `bootstrap_cube()` function to do this. It relies on the following arguments:

- **`data_cube`**:  
  The input data, either as a processed data cube (from `b3gbi::process_cube()`), or simply the dataframe inside it (i.e. `processed_cube$data`). For faster computation, passing just the dataframe is recommended.

- **`fun`**:  
  A user-defined function that computes the statistic(s) of interest from `data_cube`. This function should return a dataframe that includes a column named `diversity_val`, containing the statistic to evaluate.

- **`grouping_var`**:  
  The column(s) used for grouping the output of `fun()`. For example, if `fun()` returns one value per year, use `grouping_var = "year"`.

- **`samples`**:  
  The number of bootstrap samples to draw. Common values are 1000 or more for reliable estimates of variability and confidence intervals.

- **`seed`**:  
  An optional numeric seed to ensure reproducibility of the bootstrap resampling. Set this to a fixed value to get consistent results across runs.

- **progress**:  
  Logical flag to show a progress bar. Set to `TRUE` to enable progress reporting; default is `FALSE`.

```{r, cache=TRUE}
bootstrap_results <- bootstrap_cube(
  data_cube = processed_cube$data,
  fun = mean_obs,
  grouping_var = "year",
  samples = 1000,
  seed = 123
)
head(bootstrap_results)
```

...

## Comparison with a reference group

```{r, cache=TRUE}
bootstrap_results_ref <- bootstrap_cube(
  data_cube = processed_cube$data,
  fun = mean_obs,
  grouping_var = "year",
  samples = 1000,
  ref_group = 2011,
  seed = 123
)
head(bootstrap_results_ref)
```

...
